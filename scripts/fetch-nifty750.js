/**
 * Fetches NSE equity instruments from Upstox, filters to EQ only, and writes nifty750.ts
 * with up to 750 stocks. Run: node scripts/fetch-nifty750.js
 */
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";
import pako from "pako";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const OUT_PATH = path.join(__dirname, "..", "src", "data", "nifty750.ts");
const URL = "https://assets.upstox.com/market-quote/instruments/exchange/NSE.json.gz";
const MAX_STOCKS = 750;

async function main() {
  console.log("Fetching NSE instruments from Upstox...");
  const res = await fetch(URL);
  if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
  const gzip = new Uint8Array(await res.arrayBuffer());
  const jsonStr = pako.ungzip(gzip, { to: "string" });
  const data = JSON.parse(jsonStr);
  if (!Array.isArray(data)) throw new Error("Expected array");

  const eq = data.filter(
    (r) => r.segment === "NSE_EQ" && r.instrument_type === "EQ"
  );
  const mapped = eq.map((r) => ({
    symbol: r.trading_symbol || r.symbol || "",
    name: r.name || r.trading_symbol || "",
    instrument_key: r.instrument_key || "",
  }));
  const valid = mapped.filter(
    (r) => r.symbol && r.name && r.instrument_key.startsWith("NSE_EQ|")
  );
  valid.sort((a, b) => a.symbol.localeCompare(b.symbol));
  const list = valid.slice(0, MAX_STOCKS);

  const ts = `/**
 * Nifty 750 stocks for consolidation scan. Fetched from Upstox NSE instruments (EQ only).
 * Generated by scripts/fetch-nifty750.js
 */
export interface Nifty750Instrument {
  symbol: string;
  name: string;
  instrument_key: string;
}

export const NIFTY_750: Nifty750Instrument[] = ${JSON.stringify(list, null, 2)};
`;
  fs.writeFileSync(OUT_PATH, ts, "utf8");
  console.log("Wrote", OUT_PATH, "with", list.length, "instruments");
}

main().catch((e) => {
  console.error(e);
  process.exit(1);
});
